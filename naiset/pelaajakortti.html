<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaajakortti</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
        }

        .player-details h1 {
            margin: 0;
            font-size: 1.8rem;
            color: rgb(0, 100, 40);
        }

        .player-details p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #555;
        }

        .league-table {
            width: 50%;
            margin: 20px auto;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
        }

        .league-table th,
        .league-table td {
            border: 1px solid #ddd;
            padding: 5px;
            text-align: center;
        }

        .league-table th {
            background-color: #f2f2f2;
            color: #333;
            font-weight: bold;
        }

        .total-row {
            font-weight: bold;
            background-color: #e6e6e6;
        }

        /* Valikon perusmuotoilua */
        .game-type-select {
            margin: 0 auto 20px auto;
            text-align: center;
        }
        .game-type-select label {
            font-weight: bold;
            margin-right: 10px;
        }
        .game-type-select select {
            padding: 3px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" class="logo-link">
            <img src="HPS-logo.jpg" alt="HPS Logo" class="logo">
            <p class="logo-text">HPS Tilastot<br>1917-2024</p>
        </a>
        <nav>
            <ul class="menu">
                <li><a href="sijoitukset.html">Sijoitukset</a></li>
                <li><a href="kaudet.html">Kaudet</a></li>
                <li><a href="pelaajat.html">Pelaajat</a></li>
                <li><a href="vastustajat.html">Vastustajat</a></li>
                <li><a href="tietoja.html">Tietoja</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <div class="player-info">
            <img 
                id="player-photo" 
                alt="Pelaajan kuva" 
                class="player-photo" 
                onerror="this.onerror=null; this.src='pelaajakuvat/pelaajakuva.jpg';"
            >
            <div class="player-details">
                <h1 id="player-name"></h1>
                <p id="player-birth">s. -</p>
                <p id="player-death">k. -</p>
                <p id="player-positions"><strong>Pelipaikat:</strong> -</p>
                <p id="player-roles"><strong>Muut roolit:</strong> -</p>
            </div>
        </div>

        <!-- Valikko pelityypin valitsemiseen -->
        <div class="game-type-select">
            <label for="pelityyppi">Valitse pelityyppi:</label>
            <select id="pelityyppi">
                <option value="kaikki">Kaikki pelit</option>
                <option value="kilpailulliset" selected>Kilpailulliset pelit</option>
                <option value="sarja">Sarjapelit</option>
            </select>
        </div>

        <table id="player-stats" class="league-table">
            <thead>
                <tr>
                    <th>Vuosi</th>
                    <th>Sarjataso</th>
                    <th>Pelit yhteensä</th>
                    <th>Maalit yhteensä</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pelaajan tilastorivit luodaan JavaScriptillä -->
            </tbody>
            <tfoot>
                <tr class="total-row">
                    <td>Yhteensä</td>
                    <td>-</td>
                    <td id="total-games">0</td>
                    <td id="total-goals">0</td>
                </tr>
            </tfoot>
        </table>
    </main>

    <script>
        // 1) Haetaan URL-parametreista pelaajan etu- ja sukunimi
        const urlParams = new URLSearchParams(window.location.search);
        const sukunimi = urlParams.get('sukunimi');
        const etunimi = urlParams.get('etunimi');

        // 2) Asetetaan pelaajan nimi otsikkokenttään
        document.getElementById('player-name').textContent = `${etunimi} ${sukunimi}`;

        // 3) Yritetään näyttää pelaajan kuva nimellä "Etunimi Sukunimi.jpg"
        const playerPhoto = document.getElementById('player-photo');
        playerPhoto.src = `pelaajakuvat/${etunimi} ${sukunimi}.jpg`; 
        // Jos kuvatiedostoa ei löydy, "onerror" asettaa oletuskuvan.

        // 4) Haetaan sarjatasotiedot ja tallennetaan Kausi -> Sarjataso
        let sarjataulukot = {};
        fetch('sarjataulukot.json')
            .then(response => response.json())
            .then(data => {
                sarjataulukot = data.reduce((acc, row) => {
                    acc[row.Kausi] = row.Sarjataso;
                    return acc;
                }, {});
            });

        // 5) Haetaan pelaajadata
        let yearStats = {}; // Tänne kerätään yhteen paikkaan kaikista peleistä
        let positions = new Set();
        let roles = new Set();

        fetch('pelaajat.json')
            .then(response => response.json())
            .then(data => {
                // Suodatetaan vain valitun pelaajan tietorivit
                const filteredData = data.filter(record =>
                    record["Koko nimi"] === `${etunimi} ${sukunimi}`
                );

                // Rakennetaan "yearStats" = { 1955: { pelitKaikki, maalitKaikki, pelitKilpa, maalitKilpa, pelitSarja, maalitSarja, sarjataulo }, ... }
                // Ensin alusta rakenne
                filteredData.forEach(record => {
                    const year = record["Kausi"];
                    if (!yearStats[year]) {
                        yearStats[year] = {
                            sarjataulo: 'Ei tietoa',  // Täydennetään myöhemmin
                            pelitKaikki: 0,
                            maalitKaikki: 0,
                            pelitKilpa: 0,
                            maalitKilpa: 0,
                            pelitSarja: 0,
                            maalitSarja: 0
                        };
                    }

                    // Täydennä sarjatason tiedot, jos saatavilla
                    if (sarjataulukot[year]) {
                        yearStats[year].sarjataulo = sarjataulukot[year];
                    }

                    // Haetaan jokaiselta riviltä halutut pelimäärät (oletus: 0, jos puuttuu)
                    const pKaikki = parseInt(record["Kaikki pelit"] || 0, 10);
                    const mKaikki = parseInt(record["Kaikki maalit"] || 0, 10);

                    const pKilpa = parseInt(record["S+K pelit"] || 0, 10);
                    const mKilpa = parseInt(record["S+K maalit"] || 0, 10);

                    const pSarja = parseInt(record["S pelit"] || 0, 10);
                    const mSarja = parseInt(record["S maalit"] || 0, 10);

                    yearStats[year].pelitKaikki += pKaikki;
                    yearStats[year].maalitKaikki += mKaikki;

                    yearStats[year].pelitKilpa += pKilpa;
                    yearStats[year].maalitKilpa += mKilpa;

                    yearStats[year].pelitSarja += pSarja;
                    yearStats[year].maalitSarja += mSarja;

                    // Pelipaikat & roolit
                    if (record["Pelipaikka"]) positions.add(record["Pelipaikka"]);
                    if (record["Muu rooli"]) roles.add(record["Muu rooli"]);
                });

                // Päivitetään pelipaikat & roolit sivulle
                document.getElementById('player-positions').textContent =
                    `Pelipaikat: ${[...positions].join(', ') || '-'}`;
                document.getElementById('player-roles').textContent =
                    `Muut roolit: ${[...roles].join(', ') || '-'}`;

                // Kun sarjataulukot ja yearStats on tehty, päivitetään taulukko
                // (Huom. jos sarjataulukot-fetchi ei ole ehtinyt valmistua, meillä on jo "Ei tietoa" valmiiksi.)
                renderTable();

                // Lisätään event-kuuntelija valikkoon:
                const pelityyppiSelect = document.getElementById('pelityyppi');
                pelityyppiSelect.addEventListener('change', () => {
                    renderTable();
                });
            })
            .catch(error => console.error('Virhe ladattaessa dataa:', error));

        // 6) Funktio taulukon renderöintiin valitun pelityypin perusteella
        function renderTable() {
            const tbody = document.getElementById('player-stats').querySelector('tbody');
            const totalGamesCell = document.getElementById('total-games');
            const totalGoalsCell = document.getElementById('total-goals');

            // Tyhjennetään mahdolliset vanhat rivit
            tbody.innerHTML = '';

            // Luetaan valinta (kaikki/kilpailulliset/sarja)
            const pelityyppi = document.getElementById('pelityyppi').value;

            // Lasketaan totalit
            let totalGames = 0;
            let totalGoals = 0;

            // Käydään vuodet järjestyksessä
            const sortedYears = Object.keys(yearStats).sort((a, b) => parseInt(a) - parseInt(b));

            sortedYears.forEach(year => {
                const rowData = yearStats[year];

                let pelit = 0;
                let maalit = 0;

                if (pelityyppi === 'kaikki') {
                    pelit = rowData.pelitKaikki;
                    maalit = rowData.maalitKaikki;
                } else if (pelityyppi === 'kilpailulliset') {
                    pelit = rowData.pelitKilpa;
                    maalit = rowData.maalitKilpa;
                } else {
                    // 'sarja'
                    pelit = rowData.pelitSarja;
                    maalit = rowData.maalitSarja;
                }

                totalGames += pelit;
                totalGoals += maalit;

                // Rakennetaan rivin HTML
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${year}</td>
                    <td>${rowData.sarjataulo}</td>
                    <td>${pelit}</td>
                    <td>${maalit}</td>
                `;
                tbody.appendChild(tr);
            });

            // Päivitetään taulukon viimeisen rivin "Yhteensä"
            totalGamesCell.textContent = totalGames;
            totalGoalsCell.textContent = totalGoals;
        }
    </script>
</body>
</html>
