<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaajat</title>
    <link rel="stylesheet" href="style.css">

    <style>
        /* Madalletaan taulukon rivikorkeus ja pienennetään kuvakokoa */
        .player-table tbody tr {
            line-height: 1.0em; /* pienempi rivikorkeus */
        }
        .player-table td, .player-table th {
            padding: 2px 4px; /* vähennetään paddingia */
        }
        .player-photo {
            width: 35px;  
            height: 35px; 
            border-radius: 50%;   /* Pyöreä muoto */
            object-fit: cover;    /* Kuva rajataan täyttämään annettu koko */
        }
       /* Pienennetty HPS-logo */
        .header img {
            width: 100px;
            height: auto;
        }
        /* Asetetaan valitsimet allekkain ja keskitetään */
        .valintalista-container {
            margin: 10px 0 20px 0; /* ylä- ja ala-margin */
            display: flex;
            flex-direction: column;    /* allekkain */
            align-items: center;       /* keskelle sivusuunnassa */
            justify-content: center;
            gap: 10px;                 /* pientä väliä valitsimien välille */
        }
        .valintalista-container label {
            font-weight: bold;
            margin-right: 6px;
        }
        .valintalista-container select {
            margin-right: 10px;
        }

        /* Vihreä valikkonappi oikeassa yläkulmassa */
        .menu-button {
            position: absolute;
            top: 10px;
            right: 20%;
            width: 40px;
            height: 40px;
            background-color: rgb(0, 100, 40);
            border: none;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .menu-button div {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
        }
        .menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 20%;
            width: 200px;
            background-color: white;
            border: 2px solid rgb(0, 100, 40);
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px;
        }
        .menu a {
            display: block;
            color: rgb(0, 100, 40);
            text-decoration: none;
            font-weight: bold;
            border: 1px solid rgb(0, 100, 40);
            border-radius: 3px;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
        }
        .menu a:hover {
            background-color: rgb(0, 100, 40);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Valikkonappi -->
    <button class="menu-button" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
    </button>

    <!-- Oikean yläkulman valikko -->
    <div class="menu" id="menu">
        <a href="index.html">Etusivu</a>
        <a href="sijoitukset.html">Sijoitukset</a>
        <a href="kaudet.html">Kaudet</a>
        <a href="joukkueet.html">Joukkueet</a>
        <a href="pelaajat.html">Pelaajat</a>
        <a href="vastustajat.html">Vastustajat</a>
        <a href="tietoja.html">Tietoja</a>
    </div>

    <main>
        <div class="header">
            <a href="index.html">
                <img src="logot/HPS.jpg" alt="HPS Logo">
            </a>
            <h1 id="team-title"></h1>
            <h1 id="team-subtitle"></h1>
        </div>
        <h1>Pelaajat</h1>

        <!-- Yhteinen kontti valitsimille: ne tulevat allekkain ja keskitettyinä -->
        <div class="valintalista-container">
            <!-- 1) Järjestysvalinta (oletus: Pelimäärän mukaan) -->
            <div>
                <label for="sort-options">Valitse järjestys:</label>
                <select id="sort-options">
                    <option value="most-games" selected>Pelimäärän mukaan suurimmasta alkaen</option>
                    <option value="most-goals">Maalimäärän mukaan suurimmasta alkaen</option>
                    <option value="most-seasons">Kausien määrän mukaan suurimmasta alkaen</option>
                    <option value="first-season">Ensimmäisen kauden mukaan pienimmästä alkaen</option>
                    <option value="last-season">Viimeisen kauden mukaan suurimmasta alkaen</option>
                    <option value="alphabetical">Aakkosjärjestys</option>
                </select>
            </div>

            <!-- 2) Pelityyppi (oletus: Kilpailulliset) -->
            <div>
                <label for="pelityyppi">Valitse pelityyppi:</label>
                <select id="pelityyppi">
                    <option value="kaikki">Kaikki pelit</option>
                    <option value="kilpailulliset" selected>Kilpailulliset pelit</option>
                    <option value="sarja">Sarjapelit</option>
                </select>
            </div>
        </div>

        <table id="players-table" class="player-table">
            <thead>
                <tr>
                    <th>Kuva</th>
                    <th>Sukunimi</th>
                    <th>Etunimi</th>
                    <th>Pelipaikka</th>
                    <th>Muu rooli</th>
                    <th>Pelit</th>
                    <th>Maalit</th>
                    <th>Kausien määrä</th>
                    <th>Ensimmäinen kausi</th>
                    <th>Viimeinen kausi</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pelaajadata täytetään JavaScriptillä -->
            </tbody>
        </table>
    </main>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Lisää joukkue-parametri menu-linkkeihin
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const joukkue = urlParams.get('joukkue') || 'miehet';

            const menuLinks = document.querySelectorAll('.menu a');
            menuLinks.forEach(link => {
                const linkUrl = new URL(link.href, window.location.origin);
                linkUrl.searchParams.set('joukkue', joukkue);
                link.href = linkUrl.toString();
            });
        });

        // Haetaan data param joukkueen mukaan
        const urlParams2 = new URLSearchParams(window.location.search);
        const joukkueParam2 = (urlParams2.get('joukkue') === 'naiset') ? 'data naiset' : 'data miehet';

        fetch(`${joukkueParam2}/pelaajat.json`)
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('players-table').querySelector('tbody');
                const sortOptions = document.getElementById('sort-options');
                const pelityyppiSelect = document.getElementById('pelityyppi');

                // Käsitellään tiedot yhteen "playerTotals"-objektiin
                const playerTotals = {};

                data.forEach(record => {
                    const playerName = record["Koko nimi"];
                    const kausi = parseInt(record["Kausi"], 10) || 0;

                    if (!playerName || typeof playerName !== 'string') {
                        console.warn("Puuttuva tai virheellinen 'Koko nimi':", record);
                        return;
                    }

                    const [etunimi, ...rest] = playerName.split(' ');
                    const sukunimi = rest.join(' ') || '';

                    if (!playerTotals[playerName]) {
                        playerTotals[playerName] = {
                            etunimi: etunimi || '',
                            sukunimi: sukunimi || '',
                            pelipaikka: new Set(),
                            muuRooli: new Set(),

                            kaikki_pelit: 0,
                            kaikki_maalit: 0,

                            sk_pelit: 0,
                            sk_maalit: 0,

                            s_pelit: 0,
                            s_maalit: 0,

                            kaudet: 0,
                            ensimmäinenKausi: Infinity,
                            viimeinenKausi: -Infinity,
                        };
                    }

                    const p = playerTotals[playerName];

                    if (record["Pelipaikka"]) {
                        p.pelipaikka.add(record["Pelipaikka"]);
                    }
                    if (record["Muu rooli"]) {
                        p.muuRooli.add(record["Muu rooli"]);
                    }

                    p.kaudet += 1;
                    p.ensimmäinenKausi = Math.min(p.ensimmäinenKausi, kausi);
                    p.viimeinenKausi = Math.max(p.viimeinenKausi, kausi);

                    const pelitKaikki = parseInt(record["Kaikki pelit"] || 0, 10);
                    const maalitKaikki = parseInt(record["Kaikki maalit"] || 0, 10);

                    const pelitSK = parseInt(record["S+K pelit"] || 0, 10);
                    const maalitSK = parseInt(record["S+K maalit"] || 0, 10);

                    const pelitS = parseInt(record["S pelit"] || 0, 10);
                    const maalitS = parseInt(record["S maalit"] || 0, 10);

                    p.kaikki_pelit += pelitKaikki;
                    p.kaikki_maalit += maalitKaikki;

                    p.sk_pelit += pelitSK;
                    p.sk_maalit += maalitSK;

                    p.s_pelit += pelitS;
                    p.s_maalit += maalitS;
                });

                const players = Object.values(playerTotals);

                function renderTable(sortedPlayers) {
                    tableBody.innerHTML = '';

                    const currentPelityyppi = pelityyppiSelect.value;
                    // Luetaan \"joukkue\"-param, jotta liitetään se pelaajakorttilinkkeihin
                    const joukkueParam = (urlParams2.get('joukkue') || 'miehet');

                    sortedPlayers.forEach(player => {
                        let pelitCount = 0;
                        let maalitCount = 0;

                        if (currentPelityyppi === 'kaikki') {
                            pelitCount = player.kaikki_pelit;
                            maalitCount = player.kaikki_maalit;
                        } else if (currentPelityyppi === 'kilpailulliset') {
                            pelitCount = player.sk_pelit;
                            maalitCount = player.sk_maalit;
                        } else {
                            // 'sarja'
                            pelitCount = player.s_pelit;
                            maalitCount = player.s_maalit;
                        }

                        // Luodaan polku pelaajan kuvalle: "Etunimi Sukunimi.jpg"
                        const playerImageSrc = `pelaajakuvat/${player.etunimi} ${player.sukunimi}.jpg`;

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <img
                                  src="${playerImageSrc}"
                                  alt="Pelaajan kuva"
                                  class="player-photo"
                                  onerror="this.onerror=null;this.src='pelaajakuvat/pelaajakuva.jpg';"
                                >
                            </td>
                            <td>
                                <a href="pelaajakortti.html?sukunimi=${encodeURIComponent(player.sukunimi)}&etunimi=${encodeURIComponent(player.etunimi)}&joukkue=${encodeURIComponent(joukkueParam)}">
                                    ${player.sukunimi}
                                </a>
                            </td>
                            <td>
                                <a href="pelaajakortti.html?sukunimi=${encodeURIComponent(player.sukunimi)}&etunimi=${encodeURIComponent(player.etunimi)}&joukkue=${encodeURIComponent(joukkueParam)}">
                                    ${player.etunimi}
                                </a>
                            </td>
                            <td>${[...player.pelipaikka].join(', ')}</td>
                            <td>${[...player.muuRooli].join(', ')}</td>
                            <td>${pelitCount}</td>
                            <td>${maalitCount}</td>
                            <td>${player.kaudet}</td>
                            <td>${player.ensimmäinenKausi === Infinity ? '-' : player.ensimmäinenKausi}</td>
                            <td>${player.viimeinenKausi === -Infinity ? '-' : player.viimeinenKausi}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }

                function sortPlayers(criteria) {
                    let sortedPlayers = [...players];

                    if (criteria === 'most-games') {
                        sortedPlayers.sort((a, b) => b.kaikki_pelit - a.kaikki_pelit);
                    } else if (criteria === 'most-goals') {
                        sortedPlayers.sort((a, b) => b.kaikki_maalit - a.kaikki_maalit);
                    } else if (criteria === 'most-seasons') {
                        sortedPlayers.sort((a, b) => b.kaudet - a.kaudet);
                    } else if (criteria === 'first-season') {
                        sortedPlayers.sort((a, b) => a.ensimmäinenKausi - b.ensimmäinenKausi);
                    } else if (criteria === 'last-season') {
                        sortedPlayers.sort((a, b) => b.viimeinenKausi - a.viimeinenKausi);
                    } else {
                        // 'alphabetical'
                        sortedPlayers.sort((a, b) => a.sukunimi.localeCompare(b.sukunimi));
                    }
                    renderTable(sortedPlayers);
                }

                // Alussa: \"most-games\" & \"kilpailulliset\"
                sortPlayers('most-games');

                sortOptions.addEventListener('change', () => {
                    sortPlayers(sortOptions.value);
                });

                pelityyppiSelect.addEventListener('change', () => {
                    sortPlayers(sortOptions.value);
                });
            })
            .catch(error => console.error('Virhe ladattaessa dataa:', error));
    </script>
</body>
</html>
