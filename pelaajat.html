<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pelaajat</title>
    <link rel="stylesheet" href="style.css">

    <style>
        /* Madalletaan rivikorkeus ja lukitaan se 36px:ään */
        .player-table tbody tr {
            height: 36px; /* noin 20% vähemmän kuin aikaisemmin 45px */
            line-height: 1em; /* Varmistetaan tekstin pysyminen siistinä */
        }

        .player-table td, .player-table th {
            padding: 2px 4px;
            vertical-align: middle; /* Kuvan keskitys pysty- ja sivusuunnassa */
            text-align: center;
        }

        /* Kuvat samankokoisiksi ja pyöreiksi */
        .player-photo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Asetetaan valitsimet allekkain ja keskitetään */
        .valintalista-container {
            margin: 10px 0 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;   
            gap: 10px;
        }
        .valintalista-container label {
            font-weight: bold;
            margin-right: 6px;
        }
        .valintalista-container select {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <a href="index.html" class="logo-link">
            <img src="HPS-logo.jpg" alt="HPS Logo" class="logo">
            <p class="logo-text">HPS Tilastot<br>1917-2024</p>
        </a>
        <nav>
            <ul class="menu">
                <li><a href="sijoitukset.html">Sijoitukset</a></li>
                <li><a href="kaudet.html">Kaudet</a></li>
                <li><a href="pelaajat.html" class="active">Pelaajat</a></li>
                <li><a href="vastustajat.html">Vastustajat</a></li>
                <li><a href="tietoja.html">Tietoja</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <img src="logot/HPS.jpg" alt="HPS Logo" style="width: 100px; height: auto; display: block; margin: 0 auto;">
        <h1>Pelaajat</h1>

        <div class="valintalista-container">
            <div>
                <label for="sort-options">Valitse järjestys:</label>
                <select id="sort-options">
                    <option value="most-games" selected>Pelimäärän mukaan suurimmasta alkaen</option>
                    <option value="most-goals">Maalimäärän mukaan suurimmasta alkaen</option>
                    <option value="most-seasons">Kausien määrän mukaan suurimmasta alkaen</option>
                    <option value="first-season">Ensimmäisen kauden mukaan pienimmästä alkaen</option>
                    <option value="last-season">Viimeisen kauden mukaan suurimmasta alkaen</option>
                    <option value="alphabetical">Aakkosjärjestys</option>
                </select>
            </div>

            <div>
                <label for="pelityyppi">Valitse pelityyppi:</label>
                <select id="pelityyppi">
                    <option value="kaikki">Kaikki pelit</option>
                    <option value="kilpailulliset" selected>Kilpailulliset pelit</option>
                    <option value="sarja">Sarjapelit</option>
                </select>
            </div>
        </div>

        <table id="players-table" class="player-table">
            <thead>
                <tr>
                    <th>Kuva</th>
                    <th>Sukunimi</th>
                    <th>Etunimi</th>
                    <th>Pelipaikka</th>
                    <th>Muu rooli</th>
                    <th>Pelit</th>
                    <th>Maalit</th>
                    <th>Kausien määrä</th>
                    <th>Ensimmäinen kausi</th>
                    <th>Viimeinen kausi</th>
                </tr>
            </thead>
            <tbody>
                <!-- Pelaajadata täytetään JavaScriptillä -->
            </tbody>
        </table>
    </main>

    <script>
        fetch('pelaajat.json')
            .then(response => response.json())
            .then(data => {
                const tableBody = document.getElementById('players-table').querySelector('tbody');
                const sortOptions = document.getElementById('sort-options');
                const pelityyppiSelect = document.getElementById('pelityyppi');

                // Käsitellään tiedot yhteen "playerTotals"-objektiin
                const playerTotals = {};

                data.forEach(record => {
                    const playerName = record["Koko nimi"];
                    const kausi = parseInt(record["Kausi"], 10) || 0;

                    if (!playerName || typeof playerName !== 'string') {
                        console.warn("Puuttuva tai virheellinen 'Koko nimi':", record);
                        return; 
                    }

                    const [etunimi, ...rest] = playerName.split(' ');
                    const sukunimi = rest.join(' ') || '';

                    if (!playerTotals[playerName]) {
                        playerTotals[playerName] = {
                            etunimi: etunimi || '',
                            sukunimi: sukunimi || '',
                            pelipaikka: new Set(),
                            muuRooli: new Set(),

                            kaikki_pelit: 0,
                            kaikki_maalit: 0,

                            sk_pelit: 0,
                            sk_maalit: 0,

                            s_pelit: 0,
                            s_maalit: 0,

                            kaudet: 0,
                            ensimmäinenKausi: Infinity,
                            viimeinenKausi: -Infinity,
                        };
                    }

                    const p = playerTotals[playerName];

                    if (record["Pelipaikka"]) {
                        p.pelipaikka.add(record["Pelipaikka"]);
                    }
                    if (record["Muu rooli"]) {
                        p.muuRooli.add(record["Muu rooli"]);
                    }

                    p.kaudet += 1;
                    p.ensimmäinenKausi = Math.min(p.ensimmäinenKausi, kausi);
                    p.viimeinenKausi = Math.max(p.viimeinenKausi, kausi);

                    const pelitKaikki = parseInt(record["Kaikki pelit"] || 0, 10);
                    const maalitKaikki = parseInt(record["Kaikki maalit"] || 0, 10);

                    const pelitSK = parseInt(record["S+K pelit"] || 0, 10);
                    const maalitSK = parseInt(record["S+K maalit"] || 0, 10);

                    const pelitS = parseInt(record["S pelit"] || 0, 10);
                    const maalitS = parseInt(record["S maalit"] || 0, 10);

                    p.kaikki_pelit += pelitKaikki;
                    p.kaikki_maalit += maalitKaikki;

                    p.sk_pelit += pelitSK;
                    p.sk_maalit += maalitSK;

                    p.s_pelit += pelitS;
                    p.s_maalit += maalitS;
                });

                const players = Object.values(playerTotals);

                function renderTable(sortedPlayers) {
                    tableBody.innerHTML = '';
                    const currentPelityyppi = pelityyppiSelect.value;

                    sortedPlayers.forEach(player => {
                        let pelitCount = 0;
                        let maalitCount = 0;

                        if (currentPelityyppi === 'kaikki') {
                            pelitCount = player.kaikki_pelit;
                            maalitCount = player.kaikki_maalit;
                        } else if (currentPelityyppi === 'kilpailulliset') {
                            pelitCount = player.sk_pelit;
                            maalitCount = player.sk_maalit;
                        } else {
                            // 'sarja'
                            pelitCount = player.s_pelit;
                            maalitCount = player.s_maalit;
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>
                                <img
                                    src="pelaajakuvat/${player.etunimi} ${player.sukunimi}.jpg"
                                    alt="Pelaajan kuva"
                                    class="player-photo"
                                    onerror="this.onerror=null;this.src='pelaajakuvat/pelaajakuva.jpg';"
                                >
                            </td>
                            <td>
                                <a href="pelaajakortti.html?sukunimi=${encodeURIComponent(player.sukunimi)}&etunimi=${encodeURIComponent(player.etunimi)}">
                                    ${player.sukunimi}
                                </a>
                            </td>
                            <td>
                                <a href="pelaajakortti.html?sukunimi=${encodeURIComponent(player.sukunimi)}&etunimi=${encodeURIComponent(player.etunimi)}">
                                    ${player.etunimi}
                                </a>
                            </td>
                            <td>${[...player.pelipaikka].join(', ')}</td>
                            <td>${[...player.muuRooli].join(', ')}</td>
                            <td>${pelitCount}</td>
                            <td>${maalitCount}</td>
                            <td>${player.kaudet}</td>
                            <td>${player.ensimmäinenKausi === Infinity ? '-' : player.ensimmäinenKausi}</td>
                            <td>${player.viimeinenKausi === -Infinity ? '-' : player.viimeinenKausi}</td>
                        `;
                        tableBody.appendChild(tr);
                    });
                }

                function sortPlayers(criteria) {
                    let sortedPlayers = [...players];

                    if (criteria === 'most-games') {
                        sortedPlayers.sort((a, b) => b.kaikki_pelit - a.kaikki_pelit);
                    } else if (criteria === 'most-goals') {
                        sortedPlayers.sort((a, b) => b.kaikki_maalit - a.kaikki_maalit);
                    } else if (criteria === 'most-seasons') {
                        sortedPlayers.sort((a, b) => b.kaudet - a.kaudet);
                    } else if (criteria === 'first-season') {
                        sortedPlayers.sort((a, b) => a.ensimmäinenKausi - b.ensimmäinenKausi);
                    } else if (criteria === 'last-season') {
                        sortedPlayers.sort((a, b) => b.viimeinenKausi - a.viimeinenKausi);
                    } else {
                        // 'alphabetical'
                        sortedPlayers.sort((a, b) => a.sukunimi.localeCompare(b.sukunimi));
                    }
                    renderTable(sortedPlayers);
                }

                // Alkuasetus: "most-games" & "kilpailulliset"
                sortPlayers('most-games');

                sortOptions.addEventListener('change', () => {
                    sortPlayers(sortOptions.value);
                });

                pelityyppiSelect.addEventListener('change', () => {
                    sortPlayers(sortOptions.value);
                });
            })
            .catch(error => console.error('Virhe ladattaessa dataa:', error));
    </script>
</body>
</html>
