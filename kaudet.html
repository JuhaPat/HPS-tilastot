<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sarjataulukot</title>
    <link rel="stylesheet" href="style.css" />

    <style>
        .main-title {
            font-size: 2rem;
            color: rgb(0, 100, 40);
            margin: 0;
        }
        .sub-title {
            font-size: 1rem;
            color: rgb(100, 100, 100);
            margin: 0;
        }
        .spacer {
            height: 100px;
        }
        .extra-table {
            margin-top: 20px;
        }
        .match-table a {
            color: black;
            font-weight: bold;
            text-decoration: none;
        }

        /* Cup-kaavion peruslayout, korkeus dynaaminen */
        .cup-bracket {
            display: flex;
            justify-content: space-evenly; /* kierrokset vaakasuunnassa tasaisesti */
            align-items: flex-start;        /* Kierrokset alkavat ylhäältä (jos haluat kaikki ylös) */
            margin-top: 20px;
            /* Ei kiinteää height: -- bracket venyy sisällön mukaan */
        }

        /* Perusmäärittely bracket-roundille */
        .bracket-round {
            display: flex;
            flex-direction: column;
            align-items: flex-start;  /* alkavat vasemmasta yläreunasta */
            /* Jos haluat myös nämä pystysuuntaan keskelle, laita justify-content: center; 
               mutta ohessa teemme vain Välierät ja Loppuottelu keskelle 
            */
            margin: 0 10px;
        }

        /* VÄLIERÄT JA LOPPUOTTELU KESKELLE PYSTYSUUNNASSA */
        /* Tällöin bracket-round venyy sisällön verran, ja justify-content: center 
           keskittää ottelut, jos on ylimääräistä tilaa "kaavion" sisällä 
        */
        #round-vali, 
        #round-loppu {
            justify-content: center;  /* KESKITTYY pystysuunnassa */
            align-items: center;      /* Halutessasi myös vaakasuuntainen keskitys */
        }

        /* Otteluparin perusmarginaali */
        .match-pair {
            text-align: center;
            margin-bottom: 5px; /* pieni väli parin sisälle */
        }

        /* Joka toisen parin jälkeen isompi väli 
           => Ensimmäiset kaksi paria lähellä toisiaan, sitten isompi rako, jne.
        */
        .round-content .match-pair:nth-child(2n) {
            margin-bottom: 30px; 
        }

        /* Joukkueen laatikko 
           - ei lihavointia nimelle
           - tulos (score) isommalla fontilla
           - 2 välilyöntiä ennen tulosta
        */
        .match-pair .team {
            margin: 2px 0;
            background-color: #f1f1f1;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: normal;
            width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .match-pair .team img {
            width: 25px;
            height: 25px;
            margin-right: 5px;
        }
        .team .score {
            font-size: 1.1rem;
            font-weight: bold;
            margin-left: 0.3em;
        }

        /* Piilotetaan cup-bracket oletuksena, jos ei cup-year */
        #cup-bracket {
            display: none;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <a href="index.html" class="logo-link">
            <img src="HPS-logo.jpg" alt="HPS Logo" class="logo">
            <p class="logo-text">HPS Tilastot<br>1917-2024</p>
        </a>
        <nav>
            <ul class="menu">
                <li><a href="sijoitukset.html">Sijoitukset</a></li>
                <li><a href="kaudet.html" class="active">Kaudet</a></li>
                <li><a href="pelaajat.html">Pelaajat</a></li>
                <li><a href="vastustajat.html">Vastustajat</a></li>
                <li><a href="tietoja.html">Tietoja</a></li>
            </ul>
        </nav>
    </div>

    <main>
        <div id="header-container">
            <img src="logot/HPS.jpg" alt="HPS Logo">
            <h1 class="main-title" id="main-title"></h1>
            <h2 class="sub-title" id="sub-title"></h2>
        </div>

        <div class="year-selector">
            <button id="prev-year" class="arrow-button">&lt;</button>
            <span id="current-year">2024</span>
            <button id="next-year" class="arrow-button">&gt;</button>
        </div>

        <label for="year-dropdown">Valitse kausi:</label>
        <select id="year-dropdown"></select>

        <!-- Sarjataulukko -->
        <table id="league-table" class="league-table">
            <thead>
                <tr>
                    <th class="narrow">sij.</th>
                    <th class="wide">Joukkue</th>
                    <th class="medium">Ottelut</th>
                    <th class="medium">V</th>
                    <th class="medium">T</th>
                    <th class="medium">H</th>
                    <th class="medium">TM</th>
                    <th class="medium">PM</th>
                    <th class="medium">Pisteet</th>
                    <th class="wide">Kommentti</th>
                </tr>
            </thead>
            <tbody>
                <!-- Täytetään JavaScriptillä -->
            </tbody>
        </table>

        <!-- Cup-kaavio -->
        <div id="cup-bracket" class="cup-bracket">
            <!-- Neljännesvälierät -->
            <div class="bracket-round" id="round-neljannes">
                <h3>Neljännesvälierät</h3>
                <div class="round-content" id="round-neljannes-content"></div>
            </div>
            <!-- Puolivälierät -->
            <div class="bracket-round" id="round-puoli">
                <h3>Puolivälierät</h3>
                <div class="round-content" id="round-puoli-content"></div>
            </div>
            <!-- Välierät (keskitetään pystysuunnassa) -->
            <div class="bracket-round" id="round-vali">
                <h3>Välierät</h3>
                <div class="round-content" id="round-vali-content"></div>
            </div>
            <!-- Loppuottelu (keskitetään pystysuunnassa) -->
            <div class="bracket-round" id="round-loppu">
                <h3>Loppuottelu</h3>
                <div class="round-content" id="round-loppu-content"></div>
            </div>
        </div>

        <h2 class="extra-table" id="match-title">Pelit 2024</h2>
        <table id="match-table" class="match-table">
            <thead>
                <tr>
                    <th>Pvm</th>
                    <th>Kilpailu</th>
                    <th>Stadion</th>
                    <th>Kaupunki</th>
                    <th>Kotijoukkue</th>
                    <th>Vierasjoukkue</th>
                    <th>Tulos</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>

        <h2 class="extra-table" id="extra-title">Pelaajat ja taustahenkilöt 2024</h2>
        <table id="extra-table" class="player-table">
            <thead>
                <tr>
                    <th>Sukunimi</th>
                    <th>Etunimi</th>
                    <th>Pelipaikka</th>
                    <th>Muut roolit</th>
                    <th>Pelit</th>
                    <th>Maalit</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </main>

    <script>
        // Päivittää URL-parameterin year
        function updateURLParameter(param, value) {
            const newURL = new URL(window.location.href);
            newURL.searchParams.set(param, value);
            window.history.replaceState({}, '', newURL.toString());
        }

        // Onko Cup-vuosi (huom. 1918-1929 tai 1942)
        function isCupYear(year) {
            const y = parseInt(year, 10);
            return ((y >= 1918 && y <= 1929) || y === 1942);
        }

        function showCup() {
            document.getElementById('league-table').style.display = 'none';
            document.getElementById('cup-bracket').style.display = 'flex';
        }
        function showLeagueTable() {
            document.getElementById('cup-bracket').style.display = 'none';
            document.getElementById('league-table').style.display = 'table';
        }

        let teamLogosMap = {};

        async function loadCupData(year) {
            // Tyhjennetään entiset sisällöt
            document.getElementById('round-neljannes-content').innerHTML = '';
            document.getElementById('round-puoli-content').innerHTML = '';
            document.getElementById('round-vali-content').innerHTML = '';
            document.getElementById('round-loppu-content').innerHTML = '';

            // Näytetään kaikki kierrokset
            document.getElementById('round-neljannes').style.display = 'block';
            document.getElementById('round-puoli').style.display = 'block';
            document.getElementById('round-vali').style.display = 'flex';   // pidetään flex
            document.getElementById('round-loppu').style.display = 'flex';

            const [cupResp, teamsResp] = await Promise.all([
                fetch('cup kaaviot.json'),
                fetch('vastustajat.json')
            ]);
            const cupData = await cupResp.json();
            const teamsData = await teamsResp.json();

            // Rakennetaan Lyhenne->Logo -map
            teamLogosMap = {};
            teamsData.forEach(obj => {
                if (obj.Lyhenne && obj.Logo) {
                    teamLogosMap[obj.Lyhenne] = obj.Logo;
                }
            });

            fillCupRound(year, "Neljännesvälierät", "round-neljannes");
            fillCupRound(year, "Puolivälierät",     "round-puoli");
            fillCupRound(year, "Välierät",         "round-vali");
            fillCupRound(year, "Loppuottelu",      "round-loppu");

            function fillCupRound(kausi, kierros, elementId) {
                const roundData = cupData.filter(item => item.Kausi === kausi && item.Kierros === kierros);
                if (!roundData || roundData.length === 0) {
                    // Jos Neljännesvälierät puuttuu
                    if (kierros === 'Neljännesvälierät') {
                        document.getElementById(elementId).style.display = 'none';
                    }
                    return;
                }
                const container = document.getElementById(elementId + '-content');
                container.innerHTML = '';

                // Lisätään parit
                roundData.forEach(item => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-pair';

                    const teamDiv = document.createElement('div');
                    teamDiv.className = 'team';

                    // Joukkueen logo
                    const logoImg = document.createElement('img');
                    if (teamLogosMap[item.Joukkue]) {
                        logoImg.src = 'logot/' + teamLogosMap[item.Joukkue];
                    } else {
                        logoImg.src = 'logot/HPS-logo.jpg';
                    }
                    logoImg.alt = item.Joukkue;
                    teamDiv.appendChild(logoImg);

                    // Joukkueen nimi + kaksi välilyöntiä
                    const nameText = document.createTextNode(item.Joukkue + "  ");
                    teamDiv.appendChild(nameText);

                    // Tulos isommalla fonttikoolla
                    const scoreSpan = document.createElement('span');
                    scoreSpan.className = 'score';
                    scoreSpan.textContent = (item.Maalit ?? 0);
                    teamDiv.appendChild(scoreSpan);

                    matchDiv.appendChild(teamDiv);
                    container.appendChild(matchDiv);
                });
            }
        }

        function findExistingImage(paths) {
            let i = 0;
            return new Promise(resolve => {
                function tryNext() {
                    if (i >= paths.length) {
                        resolve(null);
                        return;
                    }
                    fetch(paths[i], { method: 'HEAD' })
                        .then(resp => {
                            if (resp.ok) {
                                resolve(paths[i]);
                            } else {
                                i++;
                                tryNext();
                            }
                        })
                        .catch(() => {
                            i++;
                            tryNext();
                        });
                }
                tryNext();
            });
        }

        async function fetchImages(otteluId) {
            const suffixes = ['', ...'abc'];
            const foundPaths = [];
            for (const suffix of suffixes) {
                const possiblePaths = [
                    `Lehtileikkeet/${otteluId}${suffix}.jpg`,
                    `Lehtileikkeet/${otteluId}${suffix}.JPG`,
                    `Kuvat/${otteluId}${suffix}.jpg`,
                    `Kuvat/${otteluId}${suffix}.JPG`
                ];
                const found = await findExistingImage(possiblePaths);
                if (found) {
                    foundPaths.push(found);
                }
            }
            return foundPaths;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const yearFromUrl = urlParams.get('year');
        let currentYear = yearFromUrl || "2024";

        fetch('sarjataulukot.json')
            .then(response => response.json())
            .then(leagueData => {
                const yearDropdown = document.getElementById('year-dropdown');
                const currentYearSpan = document.getElementById('current-year');
                const prevYearButton = document.getElementById('prev-year');
                const nextYearButton = document.getElementById('next-year');

                const tableBody = document
                    .getElementById('league-table')
                    .querySelector('tbody');
                const mainTitle = document.getElementById('main-title');
                const subTitle = document.getElementById('sub-title');
                const extraTitle = document.getElementById('extra-title');
                const matchTitle = document.getElementById('match-title');
                const matchTableBody = document.getElementById('table-body');
                const extraTableBody = document
                    .getElementById('extra-table')
                    .querySelector('tbody');

                const years = [...new Set(leagueData.map(row => row.Kausi))].sort();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearDropdown.appendChild(option);
                });

                function updateTable(year) {
                    currentYear = year;
                    currentYearSpan.textContent = year;
                    yearDropdown.value = year;
                    updateURLParameter('year', year);

                    if (isCupYear(year)) {
                        showCup();
                        loadCupData(year);
                    } else {
                        showLeagueTable();
                    }

                    const yearData = leagueData.find(row => row.Kausi === year);
                    if (yearData && yearData.Sarjataso) {
                        const [main, sub] = yearData.Sarjataso.split(',');
                        mainTitle.textContent = main.trim();
                        subTitle.textContent = sub ? sub.trim() : '';
                    } else {
                        mainTitle.textContent = 'Sarjataulukot';
                        subTitle.textContent = '';
                    }

                    extraTitle.textContent = `Pelaajat ja taustahenkilöt ${year}`;
                    matchTitle.textContent = `Pelit ${year}`;

                    if (!isCupYear(year)) {
                        renderLeagueTable(leagueData, year);
                    } else {
                        tableBody.innerHTML = '';
                    }

                    updateExtraTable(year);
                    updateMatchTable(year);
                }

                updateTable(currentYear);

                yearDropdown.addEventListener('change', () => {
                    updateTable(yearDropdown.value);
                });
                prevYearButton.addEventListener('click', () => {
                    const index = years.indexOf(currentYear);
                    if (index > 0) {
                        updateTable(years[index - 1]);
                    }
                });
                nextYearButton.addEventListener('click', () => {
                    const index = years.indexOf(currentYear);
                    if (index < years.length - 1) {
                        updateTable(years[index + 1]);
                    }
                });

                function renderLeagueTable(data, year) {
                    tableBody.innerHTML = '';
                    const filteredData = data.filter(row => row.Kausi === year);

                    filteredData.forEach(row => {
                        const tr = document.createElement('tr');
                        if (row.Joukkue && row.Joukkue.trim() === 'HPS') {
                            tr.classList.add('highlight-hps');
                        }
                        ['sij.', 'Joukkue', 'Ottelut', 'V', 'T', 'H', 'TM', 'PM', 'Pisteet'].forEach((column, index) => {
                            const td = document.createElement('td');
                            let value = row[column] || 0;
                            if (index === 1) {
                                if (row.Logo) {
                                    const logo = document.createElement('img');
                                    logo.src = `logot/${row.Logo}`;
                                    logo.className = 'team-logo';
                                    logo.style.width = '25px';
                                    logo.style.height = '25px';
                                    logo.style.marginRight = '5px';
                                    td.appendChild(logo);
                                }
                                td.appendChild(document.createTextNode(row.Joukkue));
                            } else {
                                td.textContent = value;
                            }
                            tr.appendChild(td);
                        });

                        const commentTd = document.createElement('td');
                        commentTd.textContent = row.Lisätiedot || '';
                        tr.appendChild(commentTd);

                        tableBody.appendChild(tr);
                    });
                }

                function updateExtraTable(year) {
                    fetch('pelaajat.json')
                        .then(response => response.json())
                        .then(playersData => {
                            extraTableBody.innerHTML = '';
                            const filteredPlayers = playersData.filter(p => p.Kausi === year);

                            filteredPlayers.forEach(player => {
                                const tr = document.createElement('tr');
                                ['Sukunimi', 'Etunimi', 'Pelipaikka', 'Muu rooli', 'Ottelut', 'Maalit'].forEach(column => {
                                    const td = document.createElement('td');
                                    td.textContent = player[column] || '';
                                    tr.appendChild(td);
                                });
                                extraTableBody.appendChild(tr);
                            });
                        });
                }

                function updateMatchTable(year) {
                    fetch('sarjataulukot.json')
                        .then(response => response.json())
                        .then(leagueData => {
                            const teamLogos = {};
                            leagueData.forEach(row => {
                                if (row.Joukkue && row.Logo) {
                                    teamLogos[row.Joukkue] = row.Logo;
                                }
                            });

                            fetch('ottelut.json')
                                .then(response => response.json())
                                .then(matchData => {
                                    matchTableBody.innerHTML = '';
                                    matchData
                                        .filter(match => match.Kausi == year)
                                        .forEach(match => {
                                            const tr = document.createElement('tr');
                                            ['Päivämäärä', 'Kilpailu', 'Stadion', 'Kaupunki'].forEach(col => {
                                                const td = document.createElement('td');
                                                td.textContent = match[col] || '';
                                                tr.appendChild(td);
                                            });

                                            // Kotijoukkue
                                            const homeTeamTd = document.createElement('td');
                                            if (match.Kotijoukkue && teamLogos[match.Kotijoukkue]) {
                                                const homeLogo = document.createElement('img');
                                                homeLogo.src = `logot/${teamLogos[match.Kotijoukkue]}`;
                                                homeLogo.className = 'team-logo';
                                                homeLogo.style.width = '25px';
                                                homeLogo.style.height = '25px';
                                                homeLogo.style.marginRight = '5px';
                                                homeTeamTd.appendChild(homeLogo);
                                            }
                                            homeTeamTd.appendChild(document.createTextNode(match.Kotijoukkue || ''));
                                            tr.appendChild(homeTeamTd);

                                            // Vierasjoukkue
                                            const awayTeamTd = document.createElement('td');
                                            if (match.Vierasjoukkue && teamLogos[match.Vierasjoukkue]) {
                                                const awayLogo = document.createElement('img');
                                                awayLogo.src = `logot/${teamLogos[match.Vierasjoukkue]}`;
                                                awayLogo.className = 'team-logo';
                                                awayLogo.style.width = '25px';
                                                awayLogo.style.height = '25px';
                                                awayLogo.style.marginRight = '5px';
                                                awayTeamTd.appendChild(awayLogo);
                                            }
                                            awayTeamTd.appendChild(document.createTextNode(match.Vierasjoukkue || ''));
                                            tr.appendChild(awayTeamTd);

                                            // Tulos
                                            const resultTd = document.createElement('td');
                                            const resultLink = document.createElement('a');
                                            resultLink.href = `ottelukortti.html?ottelu_id=${match.ottelu_id}`;
                                            resultLink.textContent = `${match.maalit_koti}-${match.maalit_vieras}`;
                                            resultTd.appendChild(resultLink);
                                            tr.appendChild(resultTd);

                                            matchTableBody.appendChild(tr);
                                        });
                                });
                        });
                }
            });
    </script>
</body>
</html>
