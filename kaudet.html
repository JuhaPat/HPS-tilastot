<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sarjataulukot</title>
    <link rel="stylesheet" href="style.css" />

    <style>
        .main-title {
            font-size: 2rem;
            color: rgb(0, 100, 40);
            margin: 0;
        }
        .sub-title {
            font-size: 1rem;
            color: rgb(100, 100, 100);
            margin: 0;
        }
        .spacer {
            height: 100px;
        }
       /* Pienennetty HPS-logo */
        .header img {
            width: 100px;
            height: auto;
        }
        .extra-table {
            margin-top: 20px;
        }
        .match-table a {
            color: black;
            font-weight: bold;
            text-decoration: none;
        }

        /* Cup-kaavion peruslayout, korkeus dynaaminen */
        .cup-bracket {
            display: flex;
            justify-content: space-evenly; 
            align-items: flex-start;       
            margin-top: 20px;
        }

        .bracket-round {
            display: flex;
            flex-direction: column;
            align-items: flex-start;  
            margin: 0 10px;
        }

        /* Välierät ja Loppuottelu keskitetään pystysuunnassa */
        #round-vali, 
        #round-loppu {
            justify-content: center;
            align-items: center; 
        }

        .match-pair {
            text-align: center;
            margin-bottom: 5px; 
        }
        .round-content .match-pair:nth-child(2n) {
            margin-bottom: 30px; 
        }

        .match-pair .team {
            margin: 2px 0;
            background-color: #f1f1f1;
            padding: 4px 10px;
            border-radius: 3px;
            font-weight: normal;
            width: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .match-pair .team img {
            width: 25px;
            height: 25px;
            margin-right: 5px;
        }
        .team .score {
            font-size: 1.1rem;
            font-weight: bold;
            margin-left: 0.3em;
        }

        .additional-info {
            font-size: 0.75rem; 
            color: #666;
            margin-top: 3px;   
            line-height: 1.2;  
        }

        #cup-bracket {
            display: none;
        }

        /* Pelaajataulukon suodatin */
        .pelivalitsin-container {
            margin-top: 10px;
            margin-bottom: 20px;
        }
        .pelivalitsin-label {
            font-weight: bold;
            margin-right: 10px;
        }

        /* Menu button */
        .menu-button {
            position: absolute;
            top: 10px;
            right: 20%;
            width: 40px;
            height: 40px;
            background-color: rgb(0, 100, 40);
            border: none;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .menu-button div {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
        }
        .menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 20%;
            width: 200px;
            background-color: white;
            border: 2px solid rgb(0, 100, 40);
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px;
        }
        .menu a {
            display: block;
            color: rgb(0, 100, 40);
            text-decoration: none;
            font-weight: bold;
            border: 1px solid rgb(0, 100, 40);
            border-radius: 3px;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
        }
        .menu a:hover {
            background-color: rgb(0, 100, 40);
            color: white;
        }
    </style>
    <script>
        // Funktio, joka palauttaa JSON-tiedostojen kansion nimen sen mukaan, mikä URL-parametri "joukkue" on
        function getTeamDataFolder() {
            const urlParams = new URLSearchParams(window.location.search);
            const teamParam = urlParams.get('joukkue');
            return teamParam === 'naiset' ? 'data naiset' : 'data miehet';
        }
    </script>
    
</head>

<body>
    <!-- Vihreä valikkonappi -->
    <button class="menu-button" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
    </button>
    <div class="menu" id="menu">
        <a href="index.html">Etusivu</a>
        <a href="sijoitukset.html">Sijoitukset</a>
        <a href="kaudet.html">Kaudet</a>
        <a href="joukkueet.html">Joukkueet</a>
        <a href="pelaajat.html">Pelaajat</a>
        <a href="vastustajat.html">Vastustajat</a>
        <a href="tietoja.html">Tietoja</a>
    </div>

    <main>
        <div class="header">
            <a href="index.html">
                <img src="logot/HPS.jpg" alt="HPS Logo">
            </a>
            <!-- Käytetään team-title / team-subtitle -->
            <h1 id="team-title"></h1>
            <h1 id="team-subtitle"></h1>
        </div>

        <div class="year-selector">
            <button id="prev-year" class="arrow-button">&lt;</button>
            <span id="current-year">2024</span>
            <button id="next-year" class="arrow-button">&gt;</button>
        </div>

        <label for="year-dropdown">Valitse kausi:</label>
        <select id="year-dropdown"></select>

        <!-- Sarjataulukko (ennallaan) -->
        <table id="league-table" class="league-table">
            <thead>
                <tr>
                    <th class="narrow">sij.</th>
                    <th class="wide">Joukkue</th>
                    <th class="medium">Ottelut</th>
                    <th class="medium">V</th>
                    <th class="medium">T</th>
                    <th class="medium">H</th>
                    <th class="medium">TM</th>
                    <th class="medium">PM</th>
                    <th class="medium">Pisteet</th>
                    <th class="wide">Kommentti</th>
                </tr>
            </thead>
            <tbody>
                <!-- Täytetään JavaScriptillä -->
            </tbody>
        </table>

        <!-- Cup-kaavio (ennallaan) -->
        <div id="cup-bracket" class="cup-bracket">
            <div class="bracket-round" id="round-neljannes">
                <h3>Neljännesvälierät</h3>
                <div class="round-content" id="round-neljannes-content"></div>
            </div>
            <div class="bracket-round" id="round-puoli">
                <h3>Puolivälierät</h3>
                <div class="round-content" id="round-puoli-content"></div>
            </div>
            <div class="bracket-round" id="round-vali">
                <h3>Välierät</h3>
                <div class="round-content" id="round-vali-content"></div>
            </div>
            <div class="bracket-round" id="round-loppu">
                <h3>Loppuottelu</h3>
                <div class="round-content" id="round-loppu-content"></div>
            </div>
        </div>

        <!-- Pelit (match-table) ensin -->
        <h2 class="extra-table" id="match-title">Pelit 2024</h2>
        <table id="match-table" class="match-table">
            <thead>
                <tr>
                    <th>Pvm</th>
                    <th>Kilpailu</th>
                    <th>Stadion</th>
                    <th>Kaupunki</th>
                    <th>Kotijoukkue</th>
                    <th>Vierasjoukkue</th>
                    <th>Tulos</th>
                </tr>
            </thead>
            <tbody id="table-body">
            </tbody>
        </table>

        <!-- Sitten Pelaajat alimmaiseksi -->
        <h2 class="extra-table" id="extra-title">Pelaajat ja taustahenkilöt 2024</h2>
        <!-- Pelivalitsin otsikon alapuolelle -->
        <div class="pelivalitsin-container">
            <label for="pelivalitsin" class="pelivalitsin-label">Valitse pelityyppi:</label>
            <select id="pelivalitsin">
                <option value="kaikki">Kaikki pelit</option>
                <option value="kilpailulliset">Kilpailulliset pelit</option>
                <option value="sarja">Sarjapelit</option>
            </select>
        </div>

        <table id="extra-table" class="player-table">
            <thead>
                <tr>
                    <th>Sukunimi</th>
                    <th>Etunimi</th>
                    <th>Pelipaikka</th>
                    <th>Muut roolit</th>
                    <th>Pelit</th>
                    <th>Maalit</th>
                </tr>
            </thead>
            <tbody>
                <!-- Täytetään JavaScriptillä -->
            </tbody>
        </table>
    </main>

    <script>
        function toggleMenu() {
            const menu = document.getElementById('menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        
        const dataFolder = getTeamDataFolder();

        function updateURLParameter(param, value) {
            const newURL = new URL(window.location.href);
            newURL.searchParams.set(param, value);
            window.history.replaceState({}, '', newURL.toString());
        }

        // Onko Cup-vuosi (huom. 1918-1929 tai 1942)
        function isCupYear(year) {
            const y = parseInt(year, 10);
            return ((y >= 1918 && y <= 1929) || y === 1942);
        }

        function showCup() {
            document.getElementById('league-table').style.display = 'none';
            document.getElementById('cup-bracket').style.display = 'flex';
        }
        function showLeagueTable() {
            document.getElementById('cup-bracket').style.display = 'none';
            document.getElementById('league-table').style.display = 'table';
        }

        let teamLogosMap = {};

        async function loadCupData(year) {
            document.getElementById('round-neljannes-content').innerHTML = '';
            document.getElementById('round-puoli-content').innerHTML = '';
            document.getElementById('round-vali-content').innerHTML = '';
            document.getElementById('round-loppu-content').innerHTML = '';

            document.getElementById('round-neljannes').style.display = 'block';
            document.getElementById('round-puoli').style.display = 'block';
            document.getElementById('round-vali').style.display = 'flex';
            document.getElementById('round-loppu').style.display = 'flex';

            const [cupResp, teamsResp] = await Promise.all([
                fetch(`${dataFolder}/cup kaaviot.json`),
                fetch(`${dataFolder}/vastustajat.json`)
            ]);
            const cupData = await cupResp.json();
            const teamsData = await teamsResp.json();

            teamLogosMap = {};
            teamsData.forEach(obj => {
                if (obj.Lyhenne && obj.Logo) {
                    teamLogosMap[obj.Lyhenne] = obj.Logo;
                }
            });

            fillCupRound(year, "Neljännesvälierät", "round-neljannes");
            fillCupRound(year, "Puolivälierät",     "round-puoli");
            fillCupRound(year, "Välierät",         "round-vali");
            fillCupRound(year, "Loppuottelu",      "round-loppu");

            function fillCupRound(kausi, kierros, elementId) {
                const roundData = cupData.filter(item => item.Kausi === kausi && item.Kierros === kierros);
                if (!roundData || roundData.length === 0) {
                    if (kierros === 'Neljännesvälierät') {
                        document.getElementById(elementId).style.display = 'none';
                    }
                    return;
                }
                const container = document.getElementById(elementId + '-content');
                container.innerHTML = '';

                roundData.forEach(item => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = 'match-pair';

                    if (item.Joukkue && item.Joukkue.trim() !== "") {
                        const teamDiv = document.createElement('div');
                        teamDiv.className = 'team';

                        if (teamLogosMap[item.Joukkue]) {
                            const logoImg = document.createElement('img');
                            logoImg.src = 'logot/' + teamLogosMap[item.Joukkue];
                            logoImg.alt = item.Joukkue;
                            logoImg.width = 25;
                            logoImg.height = 25;
                            logoImg.style.marginRight = '5px';
                            teamDiv.appendChild(logoImg);
                        }

                        const nameText = document.createTextNode(item.Joukkue + "  ");
                        teamDiv.appendChild(nameText);

                        if (typeof item.Maalit !== 'undefined') {
                            const scoreSpan = document.createElement('span');
                            scoreSpan.className = 'score';
                            scoreSpan.textContent = item.Maalit;
                            teamDiv.appendChild(scoreSpan);
                        }

                        matchDiv.appendChild(teamDiv);
                    }

                    if (item.Lisätieto && item.Lisätieto.trim() !== '') {
                        const infoDiv = document.createElement('div');
                        infoDiv.className = 'additional-info';
                        infoDiv.textContent = item.Lisätieto;
                        matchDiv.appendChild(infoDiv);
                    }

                    container.appendChild(matchDiv);
                });
            }
        }

        function findExistingImage(paths) {
            let i = 0;
            return new Promise(resolve => {
                function tryNext() {
                    if (i >= paths.length) {
                        resolve(null);
                        return;
                    }
                    fetch(paths[i], { method: 'HEAD' })
                        .then(resp => {
                            if (resp.ok) {
                                resolve(paths[i]);
                            } else {
                                i++;
                                tryNext();
                            }
                        })
                        .catch(() => {
                            i++;
                            tryNext();
                        });
                }
                tryNext();
            });
        }

        async function fetchImages(otteluId) {
            const suffixes = ['', ...'abcd'];
            const foundPaths = [];
            for (const suffix of suffixes) {
                const possiblePaths = [
                    `Lehtileikkeet/${otteluId}${suffix}.jpg`,
                    `Lehtileikkeet/${otteluId}${suffix}.JPG`,
                    `Kuvat/${otteluId}${suffix}.jpg`,
                    `Kuvat/${otteluId}${suffix}.JPG`
                ];
                const found = await findExistingImage(possiblePaths);
                if (found) {
                    foundPaths.push(found);
                }
            }
            return foundPaths;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const yearFromUrl = urlParams.get('year');
        let currentYear = yearFromUrl || "2024";

        fetch(`${dataFolder}/sarjataulukot.json`)
            .then(response => response.json())
            .then(leagueData => {
                const yearDropdown = document.getElementById('year-dropdown');
                const currentYearSpan = document.getElementById('current-year');
                const prevYearButton = document.getElementById('prev-year');
                const nextYearButton = document.getElementById('next-year');

                const tableBody = document
                    .getElementById('league-table')
                    .querySelector('tbody');
                // Käytetään team-title / team-subtitle:
                const mainTitle = document.getElementById('team-title');
                const subTitle = document.getElementById('team-subtitle');

                const extraTitle = document.getElementById('extra-title');
                const matchTitle = document.getElementById('match-title');
                const matchTableBody = document.getElementById('table-body');

                // Pelaajat-taulukko:
                const extraTableBody = document
                    .getElementById('extra-table')
                    .querySelector('tbody');
                const pelivalitsin = document.getElementById('pelivalitsin');

                const years = [...new Set(leagueData.map(row => row.Kausi))].sort();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearDropdown.appendChild(option);
                });

                // Pelivalitsin reagoi, jos käyttäjä vaihtaa (kaikki/kilpailulliset/sarja)
                pelivalitsin.addEventListener('change', () => {
                    // Päivitetään pelaajataulukko
                    updateExtraTable(currentYear);
                });

                function updateTable(year) {
                    currentYear = year;
                    currentYearSpan.textContent = year;
                    yearDropdown.value = year;
                    updateURLParameter('year', year);

                    if (isCupYear(year)) {
                        showCup();
                        loadCupData(year);
                    } else {
                        showLeagueTable();
                    }

                    const yearData = leagueData.find(row => row.Kausi === year);
                    if (yearData && yearData.Sarjataso) {
                        const [main, sub] = yearData.Sarjataso.split(',');
                        mainTitle.textContent = main.trim();
                        subTitle.textContent = sub ? sub.trim() : '';
                    } else {
                        mainTitle.textContent = 'Sarjataulukot';
                        subTitle.textContent = '';
                    }

                    extraTitle.textContent = `Pelaajat ja taustahenkilöt ${year}`;
                    matchTitle.textContent = `Pelit ${year}`;

                    if (!isCupYear(year)) {
                        renderLeagueTable(leagueData, year);
                    } else {
                        tableBody.innerHTML = '';
                    }

                    updateExtraTable(year);
                    updateMatchTable(year);
                }

                // Alku
                updateTable(currentYear);

                // Vuosidropdown
                yearDropdown.addEventListener('change', () => {
                    updateTable(yearDropdown.value);
                });

                prevYearButton.addEventListener('click', () => {
                    const index = years.indexOf(currentYear);
                    if (index > 0) {
                        updateTable(years[index - 1]);
                    }
                });
                nextYearButton.addEventListener('click', () => {
                    const index = years.indexOf(currentYear);
                    if (index < years.length - 1) {
                        updateTable(years[index + 1]);
                    }
                });

                function renderLeagueTable(data, year) {
                    tableBody.innerHTML = '';
                    const filteredData = data.filter(row => row.Kausi === year);

                    filteredData.forEach(row => {
                        const tr = document.createElement('tr');
                        if (row.Joukkue && row.Joukkue.trim() === 'HPS') {
                            tr.classList.add('highlight-hps');
                        }
                        ['sij.', 'Joukkue', 'Ottelut', 'V', 'T', 'H', 'TM', 'PM', 'Pisteet'].forEach((column, index) => {
                            const td = document.createElement('td');
                            let value = row[column] || 0;
                            if (index === 1) {
                                if (row.Logo) {
                                    const logo = document.createElement('img');
                                    logo.src = `logot/${row.Logo}`;
                                    logo.className = 'team-logo';
                                    logo.style.width = '25px';
                                    logo.style.height = '25px';
                                    logo.style.marginRight = '5px';
                                    td.appendChild(logo);
                                }
                                td.appendChild(document.createTextNode(row.Joukkue));
                            } else {
                                td.textContent = value;
                            }
                            tr.appendChild(td);
                        });

                        const commentTd = document.createElement('td');
                        commentTd.textContent = row.Lisätiedot || '';
                        tr.appendChild(commentTd);

                        tableBody.appendChild(tr);
                    });
                }

                // Päivitetään pelaajataulukon Ottelut/Maalit pelityyppivalinnan mukaan
                function updateExtraTable(year) {
                    fetch(`${dataFolder}/pelaajat.json`)
                        .then(response => response.json())
                        .then(playersData => {
                            extraTableBody.innerHTML = '';
                            const filteredPlayers = playersData.filter(p => p.Kausi === year);

                            const valinta = pelivalitsin.value;
                            let ottelutKentta = '';
                            let maalitKentta = '';

                            if (valinta === 'kaikki') {
                                ottelutKentta = 'Kaikki pelit';
                                maalitKentta = 'Kaikki maalit';
                            } else if (valinta === 'kilpailulliset') {
                                ottelutKentta = 'S+K pelit';
                                maalitKentta = 'S+K maalit';
                            } else {
                                // 'sarja'
                                ottelutKentta = 'S pelit';
                                maalitKentta = 'S maalit';
                            }

                            filteredPlayers.forEach(player => {
                                const tr = document.createElement('tr');

                                // Neljä peruskenttää
                                ['Sukunimi','Etunimi','Pelipaikka','Muu rooli'].forEach(field => {
                                    const td = document.createElement('td');
                                    td.textContent = player[field] || '';
                                    tr.appendChild(td);
                                });

                                // Ottelut
                                const ottelutTd = document.createElement('td');
                                ottelutTd.textContent = player[ottelutKentta] || '0';
                                tr.appendChild(ottelutTd);

                                // Maalit
                                const maalitTd = document.createElement('td');
                                maalitTd.textContent = player[maalitKentta] || '0';
                                tr.appendChild(maalitTd);

                                extraTableBody.appendChild(tr);
                            });
                        });
                }

                function updateMatchTable(year) {
                    fetch(`${dataFolder}/sarjataulukot.json`)
                        .then(response => response.json())
                        .then(leagueData => {
                            const teamLogos = {};
                            leagueData.forEach(row => {
                                if (row.Joukkue && row.Logo) {
                                    teamLogos[row.Joukkue] = row.Logo;
                                }
                            });

                            fetch(`${dataFolder}/ottelut.json`)
                                .then(response => response.json())
                                .then(matchData => {
                                    matchTableBody.innerHTML = '';
                                    matchData
                                        .filter(match => match.Kausi == year)
                                        .forEach(match => {
                                            const tr = document.createElement('tr');
                                            ['Päivämäärä', 'Kilpailu', 'Stadion', 'Kaupunki'].forEach(col => {
                                                const td = document.createElement('td');
                                                td.textContent = match[col] || '';
                                                tr.appendChild(td);
                                            });

                                            // Kotijoukkue
                                            const homeTeamTd = document.createElement('td');
                                            if (match.Kotijoukkue && teamLogos[match.Kotijoukkue]) {
                                                const homeLogo = document.createElement('img');
                                                homeLogo.src = `logot/${teamLogos[match.Kotijoukkue]}`;
                                                homeLogo.className = 'team-logo';
                                                homeLogo.style.width = '25px';
                                                homeLogo.style.height = '25px';
                                                homeLogo.style.marginRight = '5px';
                                                homeTeamTd.appendChild(homeLogo);
                                            }
                                            homeTeamTd.appendChild(document.createTextNode(match.Kotijoukkue || ''));
                                            tr.appendChild(homeTeamTd);

                                            // Vierasjoukkue
                                            const awayTeamTd = document.createElement('td');
                                            if (match.Vierasjoukkue && teamLogos[match.Vierasjoukkue]) {
                                                const awayLogo = document.createElement('img');
                                                awayLogo.src = `logot/${teamLogos[match.Vierasjoukkue]}`;
                                                awayLogo.className = 'team-logo';
                                                awayLogo.style.width = '25px';
                                                awayLogo.style.height = '25px';
                                                awayLogo.style.marginRight = '5px';
                                                awayTeamTd.appendChild(awayLogo);
                                            }
                                            awayTeamTd.appendChild(document.createTextNode(match.Vierasjoukkue || ''));
                                            tr.appendChild(awayTeamTd);

                                            // Tulos -> jos puuttuu, näytä "-"
                                            let resultText = "-";
                                            if (typeof match.maalit_koti !== 'undefined' 
                                                && typeof match.maalit_vieras !== 'undefined') {
                                                resultText = `${match.maalit_koti}-${match.maalit_vieras}`;
                                            }
                                            const resultTd = document.createElement('td');
                                            const resultLink = document.createElement('a');
                                            // Haetaan URL-parametri "joukkue" ja lisätään se linkkiin
                                            const urlParams = new URLSearchParams(window.location.search);
                                            const joukkue = urlParams.get('joukkue');
                                            resultLink.href = `ottelukortti.html?ottelu_id=${match.ottelu_id}${joukkue ? `&joukkue=${encodeURIComponent(joukkue)}` : ''}`;
                                            resultLink.textContent = resultText;
                                            resultTd.appendChild(resultLink);
                                            tr.appendChild(resultTd);

                                            matchTableBody.appendChild(tr);
                                        });
                                });
                        });
                }
            });

        // Funktio, joka lisää URL-parametrin "joukkue" kaikkiin sisäisiin linkkeihin
        function appendJoukkueParamToLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const joukkue = urlParams.get('joukkue');
            if (!joukkue) return;
            const links = document.querySelectorAll("a[href]");
            links.forEach(link => {
                let href = link.getAttribute("href");
                // Päivitetään vain sisäiset linkit (ei ulkoisia tai mailto-linkkejä)
                if (href && !href.match(/^https?:\/\//) && !href.startsWith("mailto:")) {
                    if (href.indexOf("?") === -1) {
                        href += `?joukkue=${encodeURIComponent(joukkue)}`;
                    } else {
                        let url = new URL(href, window.location.origin);
                        url.searchParams.set("joukkue", joukkue);
                        href = url.pathname + url.search;
                    }
                    link.setAttribute("href", href);
                }
            });
        }

        // Kutsutaan funktiota kun DOM on latautunut
        document.addEventListener("DOMContentLoaded", appendJoukkueParamToLinks);
    </script>
</body>
</html>
