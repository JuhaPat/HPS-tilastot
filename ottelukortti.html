<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ottelukortti</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --table-width: 40%; /* Taulukon leveys maalintekijöille */
            --result-table-width: 60%; /* Taulukon leveys tulokselle */
            --col-width-1: 20%; /* Ensimmäisen sarakkeen leveys */
            --col-width-2: 5%;  /* Toisen sarakkeen leveys */
            --col-width-3: 15%; /* Kolmannen sarakkeen leveys */
            --col-width-4: 5%;  /* Neljännen sarakkeen leveys */
            --col-width-5: 20%; /* Viidennen sarakkeen leveys */
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: none;
            background-color: transparent;
        }
        .match-details {
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1.5;
            color: rgb(0, 100, 40);
        }
        .stadium-city, .date, .officials {
            font-size: 1.2rem;
        }
        /* Headerin keskitys, jotta HPS-logo pysyy keskellä */
        .header {
            text-align: center;
        }
        /* Pienennetty HPS-logo */
        .header img {
            width: 100px;
            height: auto;
        }
        .result-table {
            width: var(--result-table-width);
            margin: 0 auto;
            border-collapse: collapse;
            text-align: center;
        }
        .result-table td {
            padding: 10px;
            border: none;
            vertical-align: middle;
        }
        .result-table td:first-child {
            width: var(--col-width-1);
            text-align: right;
        }
        .result-table td:nth-child(2) {
            width: var(--col-width-2);
        }
        .result-table td:nth-child(3) {
            width: var(--col-width-3);
        }
        .result-table td:nth-child(4) {
            width: var(--col-width-4);
        }
        .result-table td:last-child {
            width: var(--col-width-5);
            text-align: left;
        }
        .team-name {
            font-size: 1.5rem;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .team-logo {
            width: 75px;
            height: 75px;
        }
        .score {
            font-size: 3rem;
            font-weight: bold;
        }
        .additional-info {
            font-size: 0.8rem; /* Pienempi fonttikoko */
            margin-top: 10px;
            color: #666; /* Hieman haaleampi väri */
            text-align: center; /* Keskitetään lisätiedot */
        }
        .scorer-table {
            width: var(--table-width);
            margin: 20px auto;
            border-collapse: collapse;
            text-align: left;
        }
        .scorer-table td {
            padding: 10px 20px;
            border: none;
            vertical-align: top;
        }
        .scorer {
            display: flex;
            align-items: center;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        .scorer img {
            width: 20px;
            height: 20px;
            margin-right: 5px;
        }
        /* Kuvan ja kuvatekstin tyylit */
        .match-image {
            display: block;
            max-width: 80%;
            margin: 0 auto;
        }
        .image-caption {
            text-align: center;
            font-size: 0.9rem;
            color: #333;
            margin-top: 5px;
        }
        .image-container {
            margin-bottom: 20px;
        }
        /* Vihreät linkit nuolineen */
        .arrow-links {
            text-align: center; 
            margin-top: 15px;
        }
        .arrow-link {
            background-color: green;
            color: white;
            padding: 6px 12px;
            margin: 0 8px;
            text-decoration: none;
            font-weight: bold;
            border-radius: 4px;
        }
        .arrow-link:hover {
            background-color: #005500; /* Tummentaa hover-vaiheessa */
        }
        /* Oikean yläkulman navigointipainikkeen tyylit –
           Muutettu oikean marginaaliksi 20% (mallin mukainen) */
        .menu-button {
            position: absolute;
            top: 10px;
            right: 20%;
            width: 40px;
            height: 40px;
            background-color: rgb(0, 100, 40);
            border: none;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
        }
        .menu-button div {
            width: 25px;
            height: 3px;
            background-color: white;
            margin: 3px 0;
        }
        .menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 20%;
            width: 200px;
            background-color: white;
            border: 2px solid rgb(0, 100, 40);
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            padding: 5px;
            z-index: 1000;
        }
        .menu a {
            display: block;
            color: rgb(0, 100, 40);
            text-decoration: none;
            font-weight: bold;
            border: 1px solid rgb(0, 100, 40);
            border-radius: 3px;
            margin: 2px 0;
            padding: 4px 8px;
            text-align: center;
        }
        .menu a:hover {
            background-color: rgb(0, 100, 40);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Oikean yläkulman navigointipainike -->
    <button class="menu-button" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
    </button>
    <div class="menu" id="menu">
        <a href="index.html">Etusivu</a>
        <a href="sijoitukset.html">Sijoitukset</a>
        <a href="kaudet.html">Kaudet</a>
        <a href="joukkueet.html">Joukkueet</a>
        <a href="pelaajat.html">Pelaajat</a>
        <a href="vastustajat.html">Vastustajat</a>
        <a href="tilastot.html">Tilastot</a>
    </div>

    <main>
        <div class="header">
            <a href="index.html">
                <img src="logot/HPS.jpg" alt="HPS Logo">
            </a>
        </div>
        <!-- Ottelun tiedot -->
        <div class="section">
            <p class="match-details" id="competition"></p>
            <p class="stadium-city" id="stadium-city"></p>
            <p class="date" id="date"></p>
            <p class="officials" id="referee"></p>
            <p class="officials" id="attendance"></p>
            <p class="officials" id="additional-info"></p>

            <!-- Vihreät nuolinavigaatiolinkit -->
            <div class="arrow-links">
                <a id="prev-arrow" class="arrow-link" href="#">
                    Edellinen ottelu
                </a>
                <a id="next-arrow" class="arrow-link" href="#">
                    Seuraava ottelu
                </a>
            </div>
        </div>

        <!-- Ottelun tulos -->
        <div class="section">
            <table class="result-table">
                <tr>
                    <td class="team-name" id="home-name"></td>
                    <td><img src="" alt="Kotijoukkueen logo" class="team-logo" id="home-logo"></td>
                    <td class="score" id="score"></td>
                    <td><img src="" alt="Vierasjoukkueen logo" class="team-logo" id="away-logo"></td>
                    <td class="team-name" id="away-name"></td>
                </tr>
            </table>
            <p class="additional-info" id="result-additional-info"></p>
        </div>

        <!-- Maalintekijät -->
        <div class="section">
            <table class="scorer-table">
                <tr>
                    <td id="home-scorers"></td>
                    <td id="away-scorers"></td>
                </tr>
            </table>
        </div>

        <!-- Joukkueiden kokoonpanot -->
        <div class="section">
            <div class="team-roster">
                <div id="home-roster"></div>
                <div id="away-roster"></div>
            </div>
        </div>

        <!-- Ottelun lisätiedot -->
        <div class="section">
            <div class="extra-info" id="extra-info"></div>
        </div>
    </main>

    <script>
        // Navigointipainikkeen toiminto
        function toggleMenu() {
            const menu = document.getElementById('menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Käsitellään URL-parametrit
        const urlParams = new URLSearchParams(window.location.search);
        const teamParam = urlParams.get('joukkue');
        // Jos parametri on "naiset", käytetään kansiota "data naiset",
        // muuten (tai jos parametria ei ole) käytetään "data miehet".
        const dataFolder = teamParam === 'naiset' ? 'data naiset' : 'data miehet';

        // Apu-funktio: Hakee HEAD-pyynnöllä annetut polut ja palauttaa ensimmäisen löytyneen
        function findExistingImage(paths) {
            let i = 0;
            return new Promise(resolve => {
                function tryNext() {
                    if (i >= paths.length) {
                        resolve(null);
                        return;
                    }
                    fetch(paths[i], { method: 'HEAD' })
                        .then(resp => {
                            if (resp.ok) {
                                resolve(paths[i]);
                            } else {
                                i++;
                                tryNext();
                            }
                        })
                        .catch(() => {
                            i++;
                            tryNext();
                        });
                }
                tryNext();
            });
        }

        // Hakee kuvat (testaa useita tiedostopäätteitä ja kansioita)
        async function fetchImages(otteluId) {
            const suffixes = ['', ...'abc'];
            const foundPaths = [];
            for (const suffix of suffixes) {
                const possiblePaths = [
                    `Lehtileikkeet/${otteluId}${suffix}.jpg`,
                    `Lehtileikkeet/${otteluId}${suffix}.JPG`,
                    `Kuvat/${otteluId}${suffix}.jpg`,
                    `Kuvat/${otteluId}${suffix}.JPG`
                ];
                const found = await findExistingImage(possiblePaths);
                if (found) {
                    foundPaths.push(found);
                }
            }
            return foundPaths;
        }

        const otteluId = parseInt(urlParams.get('ottelu_id'), 10);

        // Globaali muuttuja ottelujen tallentamiseen navigointia varten
        let allMatches = [];

        if (otteluId) {
            // Ladataan ottelut .json-tiedostosta määritellystä data-kansiosta
            fetch(`${dataFolder}/ottelut.json`)
                .then(response => response.json())
                .then(matches => {
                    allMatches = matches;
                    const match = matches.find(m => parseInt(m.ottelu_id, 10) === otteluId);
                    if (!match) {
                        document.body.innerHTML = '<p>Ottelua ei löytynyt!</p>';
                        return;
                    }
                    const sortedMatches = [...matches].sort(
                        (a, b) => parseInt(a.ottelu_id) - parseInt(b.ottelu_id)
                    );
                    const currentIndex = sortedMatches.findIndex(
                        m => parseInt(m.ottelu_id) === otteluId
                    );

                    // Haetaan URL-parametri "joukkue", jotta se voidaan lisätä linkkeihin
                    const joukkue = urlParams.get('joukkue');

                    // Asetetaan edellisen ja seuraavan ottelun linkit niin, että myös "joukkue" kulkee mukana
                    const prevArrow = document.getElementById('prev-arrow');
                    const nextArrow = document.getElementById('next-arrow');

                    if (currentIndex > 0) {
                        const prevId = sortedMatches[currentIndex - 1].ottelu_id;
                        prevArrow.href = `ottelukortti.html?ottelu_id=${prevId}${joukkue ? `&joukkue=${encodeURIComponent(joukkue)}` : ''}`;
                    } else {
                        prevArrow.style.display = 'none';
                    }
                    if (currentIndex < sortedMatches.length - 1) {
                        const nextId = sortedMatches[currentIndex + 1].ottelu_id;
                        nextArrow.href = `ottelukortti.html?ottelu_id=${nextId}${joukkue ? `&joukkue=${encodeURIComponent(joukkue)}` : ''}`;
                    } else {
                        nextArrow.style.display = 'none';
                    }

                    // Haetaan joukkueen tiedot sarjataulukot.json-tiedostosta.
                    fetch(`${dataFolder}/sarjataulukot.json`)
                        .then(response => response.json())
                        .then(leagueData => {
                            // Luodaan sanakirja, jossa avaimena on joukkueen nimi (kenttä "Joukkue")
                            // ja arvona objekti, joka sisältää muun muassa logon tiedostonimen (kenttä "Logo").
                            const teamData = {};
                            leagueData.forEach(team => {
                                if (team.Joukkue && team.Logo) {
                                    teamData[team.Joukkue] = { logo: team.Logo, name: team.Joukkue };
                                }
                            });
                            const homeData = teamData[match.Kotijoukkue] || { name: match.Kotijoukkue, logo: 'placeholder.png' };
                            const awayData = teamData[match.Vierasjoukkue] || { name: match.Vierasjoukkue, logo: 'placeholder.png' };

                            // Asetetaan joukkueiden nimet ja logot sivulle
                            document.getElementById('home-name').textContent = homeData.name;
                            document.getElementById('home-logo').src = `logot/${homeData.logo}`;
                            document.getElementById('score').textContent = `${match.maalit_koti} - ${match.maalit_vieras}`;
                            document.getElementById('away-logo').src = `logot/${awayData.logo}`;
                            document.getElementById('away-name').textContent = awayData.name;
                            document.getElementById('result-additional-info').textContent = match.lisätietoja || '';

                            // Asetetaan ottelun muut tiedot
                            document.getElementById('competition').textContent = match.Kilpailu;
                            document.getElementById('stadium-city').textContent = `${match.Stadion}, ${match.Kaupunki}`;
                            document.getElementById('date').textContent = match.Päivämäärä;
                            document.getElementById('referee').textContent = `Erotuomari: ${match.erotuomari || 'Tieto puuttuu'}`;
                            document.getElementById('attendance').textContent = `Yleisömäärä: ${match.yleisömäärä || 'Tieto puuttuu'}`;

                            // Käsitellään maalintekijöiden tiedot
                            const parseScorers = (scorersString) => {
                                if (!scorersString) {
                                    return '<p>Ei maalintekijöitä</p>';
                                }
                                return scorersString.split(',').map(s => {
                                    const parts = s.trim().split(' ');
                                    const time = isNaN(parts[parts.length - 1]) ? '' : parts.pop();
                                    const name = parts.join(' ');
                                    return `<div class="scorer"><img src="logot/Pallo.jpg" alt="Pallo">${name}${time ? ` ${time}'` : ''}</div>`;
                                }).join('');
                            };

                            document.getElementById('home-scorers').innerHTML = parseScorers(match.maalintekijät_koti);
                            document.getElementById('away-scorers').innerHTML = parseScorers(match.maalintekijät_vieras);

                            // Haetaan lisäkuvat
                            fetchImages(otteluId).then(foundPaths => {
                                if (!foundPaths || foundPaths.length === 0) {
                                    return;
                                }
                                let extraContent = '';
                                foundPaths.forEach(path => {
                                    extraContent += `
                                        <div class="image-container">
                                            <img src="${path}" alt="Ottelun lisäkuva" class="match-image">
                                            ${match.kuvateksti && match.kuvateksti.trim() !== '' ? `<p class="image-caption">${match.kuvateksti}</p>` : ''}
                                        </div>
                                    `;
                                });
                                document.getElementById('extra-info').innerHTML = extraContent;
                            });
                        })
                        .catch(error => console.error('Virhe ladattaessa sarjataulukot.json-tiedostoa:', error));
                })
                .catch(error => console.error('Virhe ladattaessa ottelut.json-tiedostoa:', error));
        } else {
            document.getElementById('match-result').innerHTML = '<p>Ottelun tiedot puuttuvat!</p>';
        }

        // Funktio, joka lisää URL-parametrin "joukkue" kaikkiin sisäisiin linkkeihin
        function appendJoukkueParamToLinks() {
            const urlParams = new URLSearchParams(window.location.search);
            const joukkue = urlParams.get('joukkue');
            if (!joukkue) return;
            const links = document.querySelectorAll("a[href]");
            links.forEach(link => {
                let href = link.getAttribute("href");
                // Päivitetään vain sisäiset linkit (ei ulkoisia tai mailto-linkkejä)
                if (href && !href.match(/^https?:\/\//) && !href.startsWith("mailto:")) {
                    if (href.indexOf("?") === -1) {
                        href += `?joukkue=${encodeURIComponent(joukkue)}`;
                    } else {
                        let url = new URL(href, window.location.origin);
                        url.searchParams.set("joukkue", joukkue);
                        href = url.pathname + url.search;
                    }
                    link.setAttribute("href", href);
                }
            });
        }
        document.addEventListener("DOMContentLoaded", appendJoukkueParamToLinks);
    </script>
</body>
</html>
